varnishtest "priority"

h2server s1 {        
	stream 1 {
		rxreq
		txresp
		expect stream.weight == 16
		expect stream.stream == 0
	} -run
	stream 3 {
		rxreq
		txresp
		expect stream.weight == 123
		expect stream.stream == 5

		rxprio
		expect prio.weight == 10
		expect prio.stream == 7
		expect stream.weight == 10
		expect stream.stream == 7
	} -run
} -start
h2client c1 -connect ${s1_sock} {
	stream 1 {
		txreq -req GET -url /1 -hdr :scheme http -hdr :authority localhost
		rxresp
		expect stream.weight == 16
		expect stream.stream == 0
	} -run
	stream 3 {
		txreq -req GET -url /3 -hdr :scheme http -hdr :authority localhost \
			-weight 123 -exclusive -stream 5
		rxresp
		expect stream.weight == 123
		expect stream.stream == 5

		txprio -weight 10 -stream 7
		expect stream.weight == 10
		expect stream.stream == 7
	} -run
	stream 5 {
		expect stream.weight == 16
		expect stream.stream == 0
	} -run
	stream 0 {
		expect stream.weight == <undef>
		expect stream.stream == <undef>
	} -run
} -run
h2server s1 -wait
